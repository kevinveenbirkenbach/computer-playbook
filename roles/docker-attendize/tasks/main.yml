---
- name: receive {{ mail_interface_domain }} certificate
  command: certbot certonly --agree-tos --email {{ administrator_email }} --non-interactive --webroot -w /var/lib/letsencrypt/ -d {{ mail_interface_domain }}

- name: receive {{ domain }} certificate
  command: certbot certonly --agree-tos --email {{ administrator_email }} --non-interactive --webroot -w /var/lib/letsencrypt/ -d {{ domain }}

- name: configure {{domain}}.conf
  template: 
    src: roles/native-docker-reverse-proxy/templates/domain.conf.j2 
    dest: /etc/nginx/conf.d/{{domain}}.conf
  notify: restart nginx

#- name: configure {{ mail_interface_domain }}.conf
#  template: 
#    src: roles/native-docker-reverse-proxy/templates/domain.conf.j2 
#    dest: /etc/nginx/conf.d/{{ mail_interface_domain }}.conf
#  vars:
#    http_port: "{{ mail_interface_http_port }}"
#    domain:    "{{ mail_interface_domain }}"
#  notify: restart nginx

- name: register directory
  stat:
    path: "{{docker_compose_attendize_path}}"
  register: docker_compose_attendize_path_register

- name: checkout repository 
  ansible.builtin.shell: git checkout .
  become: true
  args:
    chdir: "{{docker_compose_attendize_path}}"
  when: docker_compose_attendize_path_register.stat.exists

- name: checkout Attendize repository 
  ansible.builtin.git: 
    repo: "https://github.com/Attendize/Attendize.git"
    dest: "{{docker_compose_attendize_path}}"
    version: master
  become: true

- name: Warn if repo is not reachable
  debug:
    msg: "Warning: Repository is not reachable."
  when: git_result.failed

- name: create docker-compose.yml file from template
  template:
    src: docker-compose.yml.j2
    dest: "{{docker_compose_attendize_path}}/docker-compose.yml"
    mode: 0644