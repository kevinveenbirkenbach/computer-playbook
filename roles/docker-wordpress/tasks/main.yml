---
- name: recieve wordpress certificates
  command: certbot certonly --agree-tos --email {{administrator_email}} --non-interactive --webroot -w /var/lib/letsencrypt/ -d {{item}}
  loop: "{{domains}}"

- name: configure wordpress nginx configurations
  vars:
    client_max_body_size: "2M"
    domain: "{{item}}"
  template: src=roles/native-docker-reverse-proxy/templates/domain.conf.j2 dest=/etc/nginx/conf.d/{{ item }}.conf
  loop: "{{domains}}"
  notify: restart nginx

- name: "setup wordpress"
  docker_compose:
    project_name: wordpress
    definition:
      application:
        log_driver: journald
        image: wordpress
        restart: always
        ports:
          - "127.0.0.1:{{http_port}}:80"
        environment:
          DOCKER_CLIENT_TIMEOUT:  120
          COMPOSE_HTTP_TIMEOUT:   120
          WORDPRESS_DB_HOST:      database:3306
          WORDPRESS_DB_USER:      "wordpress"
          WORDPRESS_DB_PASSWORD:  "{{wordpress_database_password}}"
          WORDPRESS_DB_NAME:      "wordpress"
        links:
          - database
        volumes:
          - wordpress-data:/var/www/html
      database:
        log_driver: journald
        image: mariadb
        restart: always
        environment:
          MYSQL_DATABASE: "wordpress"
          MYSQL_USER: "wordpress"
          MYSQL_PASSWORD: "{{wordpress_database_password}}"
          MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
        volumes:
          - wordpress-database:/var/lib/mysql
