version: '3.1'

services:

{% include 'templates/docker-service-' + database_type + '.yml.j2' %}

  synapse:
    image: matrixdotorg/synapse:latest
    container_name: mautrix-synapse
    restart: {{docker_restart_policy}}
    logging:
      driver: journald
    volumes:
      - synapse_data:/data
      - ./homeserver.yaml:/data/homeserver.yaml:ro
      - ./{{synapse_domain}}.log.config:/data/{{synapse_domain}}.log.config:ro
      - registration_files:{{registration_file_folder}}
    environment:
      - SYNAPSE_SERVER_NAME={{synapse_domain}}
      - SYNAPSE_REPORT_STATS=no
    ports:
      - "127.0.0.1:{{synapse_http_port}}:8008"
{% include 'templates/docker-container-depends-on-just-database.yml.j2' %}
{% include 'templates/docker-container-networks.yml.j2' %}
  
  element:
    image: vectorim/element-web:latest
    container_name: mautrix-element
    restart: {{docker_restart_policy}}
    volumes:
      - ./element-config.json:/app/config.json
    ports:
      - "127.0.0.1:{{element_http_port}}:80"
{% include 'templates/docker-container-networks.yml.j2' %}

  # bridges
  #mautrix-telegram:
  #  container_name: mautrix-telegram
  #  image: dock.mau.dev/mautrix/telegram:<version>
  #  restart: {{docker_restart_policy}}
  #  volumes:
  #  - telegram_bridge_data:/data

  mautrix-whatsapp:
    container_name: mautrix-whatsapp
    image: dock.mau.dev/mautrix/whatsapp:latest
    restart: {{docker_restart_policy}}
    volumes:
    - ./mautrix_whatsapp:/data
    - registration_files:{{registration_file_folder}}
{% include 'templates/docker-container-networks.yml.j2' %}

  #mautrix-facebook:
  #  container_name: mautrix-facebook
  #  image: dock.mau.dev/mautrix/facebook:<version>
  #  restart: {{docker_restart_policy}}
  #  volumes:
  #  - facebook_bridge_data:/data

  #mautrix-instagram:
  #  container_name: mautrix-instagram
  #  image: dock.mau.dev/mautrix/instagram:<version>
  #  restart: {{docker_restart_policy}}
  #  volumes:
  #  - instagram_bridge_data:/data  

{% include 'templates/docker-compose-volumes.yml.j2' %}
  synapse_data:
  #telegram_bridge_data:
  whatsapp_bridge_data:
  registration_files:
  #facebook_bridge_data:
  #instagram_bridge_data:

{% include 'templates/docker-compose-networks.yml.j2' %}